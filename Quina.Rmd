---
title: "Quina"
author: "Roberto Nogueira"
date: "January 20, 2015"
output: html_document
---

![course logo](images/getting_and_cleaning_data.jpg)`

### Getting and cleaning data

#### SOLUTION:
1. Download the file:
```{r eval=FALSE}
fileUrl <- "http://www1.caixa.gov.br/loterias/_arquivos/loterias/D_quina.zip"
download.file(fileUrl,destfile="D_quina.zip", method="wget")
dateDownloaded <- date()
```

2. Check if the file was downloaded:
```{r}
list.files(pattern="D_quina.zip")
```

3. Unzip the file that was downloaded:
```{r eval=FALSE}
unzip("data/D_quina.zip", exdir="data")
```

4. Check if the file was unzipped:
```{r}
setwd("data")
list.files(pattern="D_QUINA.HTM")
setwd("../")
```

5. Parse the file:
```{r}
webpage <- readLines("data/D_QUINA.HTM")

# Parse the html tree, ignoring errors on the page
library(XML)
pagetree <- htmlTreeParse(webpage, error=function(...){})

# Navigate your way through the tree. It may be possible to do this more efficiently using getNodeSet
body <- pagetree$children$html$children$body 
divbodyContent <- body$children$div$children[[1]]$children$div$children[[4]]
tables <- divbodyContent$children[names(divbodyContent)=="table"]

#In this case, the required table is the only one with class "wikitable sortable"  
tableclasses <- sapply(tables, function(x) x$attributes["class"])
thetable  <- tables[which(tableclasses=="wikitable sortable")]$table

#Get columns headers
headers <- thetable$children[[1]]$children
columnnames <- unname(sapply(headers, function(x) x$children$text$value))

# Get rows from table
content <- c()
for(i in 2:length(thetable$children))
{
   tablerow <- thetable$children[[i]]$children
   opponent <- tablerow[[1]]$children[[2]]$children$text$value
   others <- unname(sapply(tablerow[-1], function(x) x$children$text$value)) 
   content <- rbind(content, c(opponent, others))
}

# Convert to data frame
colnames(content) <- columnnames
as.data.frame(content)
```
